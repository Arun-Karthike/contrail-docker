# 1. Introduction
This document talk about configuration validation feature of contrailctl.

# 2. Problem statement
contrailctl currently do not validate any configuration, in which case user
may have configured a wrong configuration (may be a typo) and which could be
silently ignored without user noticed which can cause issues later.
So this behavior need to be changed and it should validate the configuration
options and fail if it has wrong configuration and possibly if wrong values.

There should be a way to define the configurations expected and their schema
the configuration passed by contrailctl must conform with the schema.

Also this can be extended to a feature where module owners can introduce or change
a service configuration entry just by defining them in the schema without adding
appropriate ansible code. Note that in certain configurations which need to be
processed within ansible would need ansible code changes.

# 3. Proposed solution

* Each contrailctl config file has corresponding json schema in which all configuration
definitions are added and validated against.
* Either contrailctl or an ansible module or may be both (may be controlled with param)
will validate the configurations against the schema
    * contrailctl validate configurations provided by config file - any config entries that
        are not in the schema should cause error
    * ansible code may also validate all final variables
        * Issue: We may have more params or variables there, so we may have to ignore certain
          variables that are not there in the schema - will need to think about this option
        * This option may be evaluated as next step after initial implementation
    * Following validations of configurations or variables should be supported
        * Required configurations - should be able to define any required configuration entries,
          absence of these configurations cause failure
        * Type of configurations - should be able to define the type like string, int, list, 
            dictionary, ipaddress etc
        * List of supported values - should be able to define list of values that are supported,
            any other values in the configuration should cause failure
        * Configurations or variables that are not defined in the schema should cause failure.
            But there may be exceptions here in case if we want to check the variables within ansible
* Eventually Developers should be able to introduce or change the configurations by adding them in the schema
    Lets consider two type of configurations which would be found in contrailctl configuration files.
    * service configurations - these configs are directly passed to service configurations.
       example - WEBUI.http_listen_port
        * Users should be able define the configruations used for only for "service configurations",
        by just editing json schema and define there without adding any ansible code
    * configurations that used in ansible to define something or converted within ansible before
    passing as service configurations. Example - GLOBAL.controller_list
        *  This kind  need to be added in schema definition as well as ansible code in order to add new config
* contrailctl should have an option to validate the configuration e.g cotrailctl config validate
* Contrailctl configuration documentation should be autogenerated from the schema files
* Once we have capability to work with json schema within ansible code (may be through a module or plugin)
we can even have schema for internal service configurations, so that developers can just change that schema
to make appropriate internal configuration changes.
## 3.1 Alternatives considered
None

## 3.2 User workflow impact
Unless the user configured contrailctl configuration is not conformed with respective configuration schema,
contrailctl exection will fail.

# 4. Implementation
## Phase 1
* Each configuration file will have a different json schema file which will be part of contrailctl codebase.
* contrailctl to be changed to validate the configuration files against respective schema and fail itself
in case of any validation failures
* contrailctl should have a new param - contrailctl config validate which validate the configuration file

## Phase 2
* Need to decide whether we need to have this validation in the ansible code also, in which this need to be
implemented as a module or a plugin
* Since there may be other variables also within the ansible code, we would have to ignore any variable
that are not defined in the schema in this case

## Phase 3
* Developers should be able to introduce new configuration or change/delete exsting configurations with
minimal effort
* Once ansible code has capability to work with json schema (may be through a module or plugin) we can even
have schema for internal service configurations, so that developers can just change that schema to make
appropriate internal configuration changes.

### Case 1: service configurations
These configurations in contrailctl config will be the options that are directly passed to service
configurations without any more processing or changes within ansible code. 
Example - WEBUI.http_listen_port - this is converted to ansible variable named webui_http_listen_port
and passed it to webui configuration. Developers should be able to introduce new configurations or
remove/change existing configurations by add/remove/change them in the schema without any further
ansible code changes so that those new configurations will be avilable for users

* Ansible code should not have any unnecessary conversions or changes in the variables in this type of
configurations to support this feature. Existing ansible code need to be checked for this

### Case 2: Configurations that are processed within ansible
This kind of configurations will be processed within ansible for any logic within ansible or to convert
them to different form before passing them to service configurations. To add or change this type of
configuration need add/change/remove from schema as well as appropriate ansible code changes.

## Phase 4
Contrailctl configuration documentation may be autogenerated from schema.

# 5. Dependencies
This feature is part of contrailctl that work with contrail 4.0 containers

# 6. Testing

# 7. Documentation Impact

# 8. References
